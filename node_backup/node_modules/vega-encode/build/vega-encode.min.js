!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("vega-scale"),require("vega-util"),require("d3-format"),require("vega-dataflow"),require("d3-array"),require("d3-interpolate")):"function"==typeof define&&define.amd?define(["exports","vega-scale","vega-util","d3-format","vega-dataflow","d3-array","d3-interpolate"],n):n((e.vega=e.vega||{},e.vega.transforms={}),e.vega,e.vega,e.d3,e.vega,e.d3,e.d3)}(this,function(e,x,k,u,g,v,i){"use strict";var b="log",S="pow",O="sqrt",o="band",l="point",s="linear",A="ordinal",f="quantile",c="quantize",y="threshold",d="bin-ordinal",m="sequential";function D(e,n){var t;return k.isObject(n)&&(t=n.step,n=n.interval),k.isString(n)&&(n="time"===e.type?x.timeInterval(n):"utc"===e.type?x.utcInterval(n):k.error("Only time and utc scales accept interval strings."),t&&(n=n.every(t))),n}function p(n,e,t){var r=n.range(),a=r[0],i=k.peek(r);if(i<a&&(r=i,i=a,a=r),e=e.filter(function(e){return!((e=n(e))<a||i<e)}),0<t&&1<e.length){for(var o=[e[0],k.peek(e)];e.length>t&&3<=e.length;)e=e.filter(function(e,n){return!(n%2)});e.length<3&&(e=o)}return e}function M(e,n){return e.ticks?e.ticks(n):e.domain()}function w(e,n,t){var r,a,i=e.tickFormat?e.tickFormat(n,t):t?u.format(t):String;return e.type===b?(r=i,a=function(e){var n=u.formatSpecifier(e||",");{if(null==n.precision){switch(n.precision=12,n.type){case"%":n.precision-=2;break;case"e":n.precision-=1}return i=u.format(n),o=u.format(".1f")(1)[1],function(e){var n,t,r=i(e),a=r.indexOf(o);if(a<0)return r;for(n=function(e,n){var t,r=e.lastIndexOf("e");if(0<r)return r;for(r=e.length;--r>n;)if(48<=(t=e.charCodeAt(r))&&t<=57)return r+1}(r,a),t=n<r.length?r.slice(n):"";--n>a;)if("0"!==r[n]){++n;break}return r.slice(0,n)+t}}return u.format(n)}var i,o}(t),function(e){return r(e)?a(e):""}):i}function n(e){g.Transform.call(this,null,e)}function t(e){g.Transform.call(this,null,e)}function h(){return g.ingest({})}function T(e){return e.exit}function r(e){g.Transform.call(this,null,e)}k.inherits(n,g.Transform).transform=function(e,n){if(this.value&&!e.modified())return n.StopPropagation;var t=n.fork(n.NO_SOURCE|n.NO_FIELDS),r=this.value,a=e.scale,i=null==e.count?e.values?e.values.length:10:D(a,e.count),o=e.format||w(a,i,e.formatSpecifier),u=e.values?p(a,e.values,i):M(a,i);return r&&(t.rem=r),r=u.map(function(e,n){return g.ingest({index:n/(u.length-1),value:e,label:o(e)})}),e.extra&&r.length&&r.push(g.ingest({index:-1,extra:{value:r[0].value},label:""})),t.source=r,t.add=r,this.value=r,t},k.inherits(t,g.Transform).transform=function(e,n){var t=n.dataflow,r=n.fork(n.NO_SOURCE|n.NO_FIELDS),a=e.item||h,i=e.key||g.tupleid,o=this.value;return k.isArray(r.encode)&&(r.encode=null),o&&(e.modified("key")||n.modified(i))&&k.error("DataJoin does not support modified key function or fields."),o||(n=n.addAll(),this.value=o=k.fastmap().test(T),o.lookup=function(e){return o.get(i(e))}),n.visit(n.ADD,function(e){var n=i(e),t=o.get(n);t?t.exit?(o.empty--,r.add.push(t)):r.mod.push(t):(o.set(n,t=a(e)),r.add.push(t)),t.datum=e,t.exit=!1}),n.visit(n.MOD,function(e){var n=i(e),t=o.get(n);t&&(t.datum=e,r.mod.push(t))}),n.visit(n.REM,function(e){var n=i(e),t=o.get(n);e!==t.datum||t.exit||(r.rem.push(t),t.exit=!0,++o.empty)}),n.changed(n.ADD_MOD)&&r.modifies("datum"),e.clean&&o.empty>t.cleanThreshold&&t.runAfter(o.clean),r},k.inherits(r,g.Transform).transform=function(t,e){var r=e.fork(e.ADD_REM),n=t.encoders,a=e.encode;if(k.isArray(a)){if(!r.changed()&&!a.every(function(e){return n[e]}))return e.StopPropagation;a=a[0],r.encode=null}var i="enter"===a,o=n.update||k.falsy,u=n.enter||k.falsy,l=n.exit||k.falsy,s=(a&&!i?n[a]:o)||k.falsy;if(e.changed(e.ADD)&&(e.visit(e.ADD,function(e){u(e,t),o(e,t),s!==k.falsy&&s!==o&&s(e,t)}),r.modifies(u.output),r.modifies(o.output),s!==k.falsy&&s!==o&&r.modifies(s.output)),e.changed(e.REM)&&l!==k.falsy&&(e.visit(e.REM,function(e){l(e,t)}),r.modifies(l.output)),i||s!==k.falsy){var f=e.MOD|(t.modified()?e.REFLOW:0);i?(e.visit(f,function(e){var n=u(e,t);(s(e,t)||n)&&r.mod.push(e)}),r.mod.length&&r.modifies(u.output)):e.visit(f,function(e){s(e,t)&&r.mod.push(e)}),r.mod.length&&r.modifies(s.output)}return r.changed()?r:e.StopPropagation};var z="symbol",E={};function F(e,n,t){return t===z&&E[e.type]?(o=n,function(e,n,t){var r=t[n+1]||t.max||1/0,a=R(e,o),i=R(r,o);return a&&i?a+"–"+i:i?"< "+i:"≥ "+a}):"discrete"===t?(a=n,function(e,n){return n?a(e):null}):(r=n,function(e){return r(e)});var r,a,o}function R(e,n){return isFinite(e)?n(e):null}function a(e){g.Transform.call(this,[],e)}E[f]=function(e){var n=[-1/0].concat(e.quantiles());return n.max=1/0,n},E[c]=function(e){var n=e.domain(),t=n[0],r=k.peek(n),a=e.range().length,i=new Array(a),o=0;i[0]=-1/0;for(;++o<a;)i[o]=(o*r-(o-a)*t)/a;return i.max=1/0,i},E[y]=function(e){var n=[-1/0].concat(e.domain());return n.max=1/0,n},E["bin-linear"]=E[d]=function(e){var n=e.domain();return n.max=n.pop(),n},k.inherits(a,g.Transform).transform=function(t,e){if(null!=this.value&&!t.modified())return e.StopPropagation;var n,r,a,i,o,u,l,s=e.fork(e.NO_SOURCE|e.NO_FIELDS),f=this.value,c=t.type||z,d=t.scale,m=null==t.count?5:D(d,t.count),p=t.format||w(d,m,t.formatSpecifier),h=t.values||(u=m,(l=E[(o=d).type])?l(o):M(o,u));return p=F(d,p,c),f&&(s.rem=f),c===z?(k.isFunction(a=t.size)?(t.values||0!==d(h[0])||(h=h.slice(1)),i=h.reduce(function(e,n){return Math.max(e,a(n,t))},0)):a=k.constant(i=a||8),f=h.map(function(e,n){return g.ingest({index:n,label:p(e,n,h),value:e,offset:i,size:a(e,t)})})):"gradient"===c?(n=d.domain(),r=x.scaleFraction(d,n[0],k.peek(n)),h.length<3&&!t.values&&n[0]!==k.peek(n)&&(h=[n[0],k.peek(n)]),f=h.map(function(e,n){return g.ingest({index:n,label:p(e,n,h),value:e,perc:r(e)})})):(a=h.length-1,r=function(e){var n=e.domain(),t=n.length-1,r=+n[0],a=+k.peek(n),i=a-r;if(e.type===y){var o=t?i/t:.1;i=(a+=o)-(r-=o)}return function(e){return(e-r)/i}}(d),f=h.map(function(e,n){return g.ingest({index:n,label:p(e,n,h),value:e,perc:n?r(e):0,perc2:n===a?1:r(h[n+1])})})),s.source=f,s.add=f,this.value=f,s};var I=k.fastmap({line:N,"line-radial":function(e,n,t,r){return N(n*Math.cos(e),n*Math.sin(e),r*Math.cos(t),r*Math.sin(t))},arc:U,"arc-radial":function(e,n,t,r){return U(n*Math.cos(e),n*Math.sin(e),r*Math.cos(t),r*Math.sin(t))},curve:j,"curve-radial":function(e,n,t,r){return j(n*Math.cos(e),n*Math.sin(e),r*Math.cos(t),r*Math.sin(t))},"orthogonal-horizontal":function(e,n,t,r){return"M"+e+","+n+"V"+r+"H"+t},"orthogonal-vertical":function(e,n,t,r){return"M"+e+","+n+"H"+t+"V"+r},"orthogonal-radial":function(e,n,t,r){var a=Math.cos(e),i=Math.sin(e),o=Math.cos(t),u=Math.sin(t),l=Math.abs(t-e)>Math.PI?t<=e:e<t;return"M"+n*a+","+n*i+"A"+n+","+n+" 0 0,"+(l?1:0)+" "+n*o+","+n*u+"L"+r*o+","+r*u},"diagonal-horizontal":function(e,n,t,r){var a=(e+t)/2;return"M"+e+","+n+"C"+a+","+n+" "+a+","+r+" "+t+","+r},"diagonal-vertical":function(e,n,t,r){var a=(n+r)/2;return"M"+e+","+n+"C"+e+","+a+" "+t+","+a+" "+t+","+r},"diagonal-radial":function(e,n,t,r){var a=Math.cos(e),i=Math.sin(e),o=Math.cos(t),u=Math.sin(t),l=(n+r)/2;return"M"+n*a+","+n*i+"C"+l*a+","+l*i+" "+l*o+","+l*u+" "+r*o+","+r*u}});function C(e){return e.source.x}function L(e){return e.source.y}function P(e){return e.target.x}function q(e){return e.target.y}function _(e){g.Transform.call(this,{},e)}function N(e,n,t,r){return"M"+e+","+n+"L"+t+","+r}function U(e,n,t,r){var a=t-e,i=r-n,o=Math.sqrt(a*a+i*i)/2;return"M"+e+","+n+"A"+o+","+o+" "+180*Math.atan2(i,a)/Math.PI+" 0 1 "+t+","+r}function j(e,n,t,r){var a=t-e,i=r-n,o=.2*(a+i),u=.2*(i-a);return"M"+e+","+n+"C"+(e+o)+","+(n+u)+" "+(t+u)+","+(r-o)+" "+t+","+r}function X(e){g.Transform.call(this,null,e)}_.Definition={type:"LinkPath",metadata:{modifies:!0},params:[{name:"sourceX",type:"field",default:"source.x"},{name:"sourceY",type:"field",default:"source.y"},{name:"targetX",type:"field",default:"target.x"},{name:"targetY",type:"field",default:"target.y"},{name:"orient",type:"enum",default:"vertical",values:["horizontal","vertical","radial"]},{name:"shape",type:"enum",default:"line",values:["line","arc","curve","diagonal","orthogonal"]},{name:"as",type:"string",default:"path"}]},k.inherits(_,g.Transform).transform=function(e,n){var t=e.sourceX||C,r=e.sourceY||L,a=e.targetX||P,i=e.targetY||q,o=e.as||"path",u=e.orient||"vertical",l=e.shape||"line",s=I.get(l+"-"+u)||I.get(l);return s||k.error("LinkPath unsupported type: "+e.shape+(e.orient?"-"+e.orient:"")),n.visit(n.SOURCE,function(e){e[o]=s(t(e),r(e),a(e),i(e))}),n.reflow(e.modified()).modifies(o)},X.Definition={type:"Pie",metadata:{modifies:!0},params:[{name:"field",type:"field"},{name:"startAngle",type:"number",default:0},{name:"endAngle",type:"number",default:6.283185307179586},{name:"sort",type:"boolean",default:!1},{name:"as",type:"string",array:!0,length:2,default:["startAngle","endAngle"]}]},k.inherits(X,g.Transform).transform=function(e,n){var t,r,a,i=e.as||["startAngle","endAngle"],o=i[0],u=i[1],l=e.field||k.one,s=e.startAngle||0,f=null!=e.endAngle?e.endAngle:2*Math.PI,c=n.source,d=c.map(l),m=d.length,p=s,h=(f-s)/v.sum(d),g=v.range(m);for(e.sort&&g.sort(function(e,n){return d[e]-d[n]}),t=0;t<m;++t)a=d[g[t]],(r=c[g[t]])[o]=p,r[u]=p+=a*h;return this.value=d,n.reflow(e.modified()).modifies(i)};var Y=5,V=k.toSet([s,S,O]),G=k.toSet([s,b,S,O,"time","utc"]),H=k.toSet(["set","modified","clear","type","scheme","schemeExtent","schemeCount","domain","domainMin","domainMid","domainMax","domainRaw","domainImplicit","nice","zero","range","rangeStep","round","reverse","interpolate","interpolateGamma"]);function B(e){g.Transform.call(this,null,e),this.modified(!0)}function J(e,n,t){e===b&&(Math.abs(n.reduce(function(e,n){return e+(n<0?-1:0<n?1:0)},0))!==n.length&&t.warn("Log scale domain includes zero: "+k.stringValue(n)));return n}function W(e,n,t){return k.isFunction(e)&&(n||t)?x.interpolateRange(e,K(n||[0,1],t)):e}function K(e,n){return n?e.slice().reverse():e}function Q(e){g.Transform.call(this,null,e)}k.inherits(B,g.Transform).transform=function(e,n){var t,r=n.dataflow,a=this.value;for(t in a&&!e.modified("type")||(this.value=a=x.scale((e.type||s).toLowerCase())()),e)if(!H[t]){if("padding"===t&&G[a.type])continue;k.isFunction(a[t])?a[t](e[t]):r.warn("Unsupported scale property: "+t)}return function(e,n,t){var r=n.round||!1,a=n.range;if(null!=n.rangeStep)a=function(e,n,t){e!==o&&e!==l&&k.error("Only band and point scales support rangeStep.");var r=(null!=n.paddingOuter?n.paddingOuter:n.padding)||0,a=e===l?1:(null!=n.paddingInner?n.paddingInner:n.padding)||0;return[0,n.rangeStep*x.bandSpace(t,a,r)]}(e.type,n,t);else if(n.scheme){if(a=function(e,n,t){var r,a=n.scheme.toLowerCase(),i=x.scheme(a),o=n.schemeExtent;i||k.error("Unrecognized scheme name: "+n.scheme);return t=e===y?t+1:e===d?t-1:e===f||e===c?+n.schemeCount||Y:t,e===m?W(i,o,n.reverse):!o&&(r=x.scheme(a+"-"+t))?r:k.isFunction(i)?function(e,n){for(var t=new Array(n),r=n+1,a=0;a<n;)t[a]=e(++a/r);return t}(W(i,o),t):e===A?i:i.slice(0,t)}(e.type,n,t),k.isFunction(a))return e.interpolator(a)}else if(a&&e.type===m)return e.interpolator(i.interpolateRgbBasis(K(a,n.reverse)));a&&n.interpolate&&e.interpolate?e.interpolate(x.interpolate(n.interpolate,n.interpolateGamma)):k.isFunction(e.round)?e.round(r):k.isFunction(e.rangeRound)&&e.interpolate(r?i.interpolateRound:i.interpolate);a&&e.range(K(a,n.reverse))}(a,e,function(e,n,t){var r=(a=e,i=n.domainRaw,o=t,i?(a.domain(J(a.type,i,o)),i.length):-1);var a,i,o;if(-1<r)return r;var u,l,s=n.domain,f=e.type,c=n.zero||void 0===n.zero&&V[f];if(!s)return 0;G[f]&&n.padding&&s[0]!==k.peek(s)&&(d=f,m=s,p=n.range,h=n.padding,g=n.exponent,v=Math.abs(k.peek(p)-p[0]),y=v/(v-2*h),M=d===b?k.zoomLog(m,null,y):d===O?k.zoomPow(m,null,y,.5):d===S?k.zoomPow(m,null,y,g):k.zoomLinear(m,null,y),(m=m.slice())[0]=M[0],m[m.length-1]=M[1],s=m);var d,m,p,h,g,v,y,M;(c||null!=n.domainMin||null!=n.domainMax||null!=n.domainMid)&&(u=(s=s.slice()).length-1||1,c&&(0<s[0]&&(s[0]=0),s[u]<0&&(s[u]=0)),null!=n.domainMin&&(s[0]=n.domainMin),null!=n.domainMax&&(s[u]=n.domainMax),null!=n.domainMid&&(((l=n.domainMid)<s[0]||l>s[u])&&t.warn("Scale domainMid exceeds domain min or max.",l),s.splice(u,0,l)));e.domain(J(f,s,t)),f===A&&e.unknown(n.domainImplicit?x.scaleImplicit:void 0);n.nice&&e.nice&&e.nice(!0!==n.nice&&D(e,n.nice)||null);return s.length}(a,e,r)),n.fork(n.NO_SOURCE|n.NO_FIELDS)},k.inherits(Q,g.Transform).transform=function(e,n){var t=e.modified("sort")||n.changed(n.ADD)||n.modified(e.sort.fields)||n.modified("datum");return t&&n.source.sort(e.sort),this.modified(t),n};function Z(e){g.Transform.call(this,null,e)}function $(e,n,t,r,a){for(var i,o=(n-e.sum)/2,u=e.length,l=0;l<u;++l)(i=e[l])[r]=o,i[a]=o+=Math.abs(t(i))}function ee(e,n,t,r,a){for(var i,o=1/e.sum,u=0,l=e.length,s=0,f=0;s<l;++s)(i=e[s])[r]=u,i[a]=u=o*(f+=Math.abs(t(i)))}function ne(e,n,t,r,a){for(var i,o,u=0,l=0,s=e.length,f=0;f<s;++f)(i=t(o=e[f]))<0?(o[r]=l,o[a]=l+=i):(o[r]=u,o[a]=u+=i)}Z.Definition={type:"Stack",metadata:{modifies:!0},params:[{name:"field",type:"field"},{name:"groupby",type:"field",array:!0},{name:"sort",type:"compare"},{name:"offset",type:"enum",default:"zero",values:["zero","center","normalize"]},{name:"as",type:"string",array:!0,length:2,default:["y0","y1"]}]},k.inherits(Z,g.Transform).transform=function(e,n){var t,r,a,i,o=e.as||["y0","y1"],u=o[0],l=o[1],s=e.field||k.one,f="center"===e.offset?$:"normalize"===e.offset?ee:ne;for(r=0,a=(t=function(e,n,t,r){var a,i,o,u,l,s,f,c,d,m=[],p=function(e){return e(l)};if(null==n)m.push(e.slice());else for(a={},i=0,o=e.length;i<o;++i)l=e[i],s=n.map(p),(f=a[s])||(a[s]=f=[],m.push(f)),f.push(l);for(d=s=0,u=m.length;s<u;++s){for(f=m[s],c=i=0,o=f.length;i<o;++i)c+=Math.abs(r(f[i]));f.sum=c,d<c&&(d=c),t&&f.sort(t)}return m.max=d,m}(n.source,e.groupby,e.sort,s)).length,i=t.max;r<a;++r)f(t[r],i,s,u,l);return n.reflow(e.modified()).modifies(o)},e.axisticks=n,e.datajoin=t,e.encode=r,e.legendentries=a,e.linkpath=_,e.pie=X,e.scale=B,e.sortitems=Q,e.stack=Z,e.validTicks=p,Object.defineProperty(e,"__esModule",{value:!0})});